<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>字幕组机翻小助手 0.0.2</title>
  <link rel="stylesheet" href="./assets/css/normalize.min.css">
  <link rel="stylesheet" href="./assets/css/index.css">
</head>

<body>
  <div id="vue-app">
    <input type="file" style='display:none;' id='file-input' @change="process_file($event)" ref="input" accept=".srt,.ass,text/srt,text/ass" aria-multiselectable="true" multiple />

    <!-- selected file | 选文件后显示这块 -->
    <div id='selected-file-area' v-if="files.length" @drop="process_file($event)">
      <div class="translate-setting">
        源语言
        <select v-model="srcLang">
            <option v-for="val, key in supportLang" :value="key" :key="key">{{val}}</option>
        </select>
        目标语言
        <select v-model="distLang">
            <option v-for="val, key in supportLang" :value="key" :key="key">{{val}}</option>
        </select>
        <button @click="startTranslate">开始翻译</button>
      </div>
      <div class="file-box" v-for="file in files" :class="statusText[file.status][0]">
        <div class="file-info">
          <div class="file-info-left">
            <img src="./assets/img/srt.svg" class="selected-file-icon" v-if="file.type == 'srt'">
            <img src="./assets/img/ass.svg" class="selected-file-icon" v-if="file.type == 'ass'">
          </div>
          <div class="file-info-right">
            <div class="file-name">
              {{file.name}}
            </div>
            <div class="file-size">
              {{file.size}}

              <span style="margin-left: 10px;">{{statusText[file.status][1]}}</span>
            </div>
          </div>
        </div>
        <div class='file-action'>
          <!-- <div class="file-btn file-edit" v-if="file.status == 2" @click='editFile(file)'>
            <img src="./assets/img/edit.svg" >
          </div> -->
          <div class="file-btn file-download" v-if="file.status == 2" @click='downloadFile(file)'>
            <img src="./assets/img/download.svg" >
          </div>
          <div class="file-btn file-close" @click='removeFile(file)'>
            <img src="./assets/img/close.svg">
          </div>
        </div>
      </div>
    </div>

    <!-- file area | 还没选择文件 -->
    <div class="dropzone-wrapper" v-if='!files.length' @drop="process_file($event)">
      <!-- animate border -->
      <div class='topbottom'></div>
      <div class='leftright'></div>
      <!-- 提示选择文件区 -->
      <div id="dropzone">
        <div id='hint' @click="toSelect">
          <div id='image'>
            <img src="./assets/img/srt logo.png" alt="srt logo">
            <img src="./assets/img/ass logo.png" alt="ass logo" style='margin-left:48px;'>
          </div>
          <div id='text'>
            <div class='main-title'>
              <div>拖入文件或</div>
              <div class='click-here-to-select-file' >点击此处选择文件</div>
            </div>
            <p class='secondary-title'>支持 .srt .ass 字幕文件</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

<!-- script -->
<script src="./assets/js/vue.min.js"></script>
<script src="./assets/js/jquery-3.2.1.min.js"></script>
<script>
  var pos = 0
  var $dragzone
  const {webContents} = require('electron').remote
  const { translate, download } = require('./src/translate.js');

  // 返回文件后缀 "srt" / "ass"
  function get_suffix(filename) {
    return filename.split('.').pop()
  }

  function properFileSize(fileSizeInBytes) {
    var i = -1;
    var byteUnits = [' kB', ' MB', ' GB', ' TB', 'PB', 'EB', 'ZB', 'YB'];
    do {
      fileSizeInBytes = fileSizeInBytes / 1024;
      i++;
    } while (fileSizeInBytes > 1024);
    return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
  }

  var app = new Vue({
    el: '#vue-app',
    data: {
      supportLang: {
        'auto': '自动识别',
        'zh-cn': '简体中文',
        'zh-tw': '繁体中文',
        'en': '英语',
        'af': 'Afrikaans',
        'sq': 'Albanian',
        'am': 'Amharic',
        'ar': 'Arabic',
        'hy': 'Armenian',
        'az': 'Azerbaijani',
        'eu': 'Basque',
        'be': 'Belarusian',
        'bn': 'Bengali',
        'bs': 'Bosnian',
        'bg': 'Bulgarian',
        'ca': 'Catalan',
        'ceb': 'Cebuano',
        'ny': 'Chichewa',
        'co': 'Corsican',
        'hr': 'Croatian',
        'cs': 'Czech',
        'da': 'Danish',
        'nl': 'Dutch',
        'eo': 'Esperanto',
        'et': 'Estonian',
        'tl': 'Filipino',
        'fi': 'Finnish',
        'fr': 'French',
        'fy': 'Frisian',
        'gl': 'Galician',
        'ka': 'Georgian',
        'de': 'German',
        'el': 'Greek',
        'gu': 'Gujarati',
        'ht': 'Haitian Creole',
        'ha': 'Hausa',
        'haw': 'Hawaiian',
        'iw': 'Hebrew',
        'hi': 'Hindi',
        'hmn': 'Hmong',
        'hu': 'Hungarian',
        'is': 'Icelandic',
        'ig': 'Igbo',
        'id': 'Indonesian',
        'ga': 'Irish',
        'it': 'Italian',
        'ja': 'Japanese',
        'jw': 'Javanese',
        'kn': 'Kannada',
        'kk': 'Kazakh',
        'km': 'Khmer',
        'ko': 'Korean',
        'ku': 'Kurdish (Kurmanji)',
        'ky': 'Kyrgyz',
        'lo': 'Lao',
        'la': 'Latin',
        'lv': 'Latvian',
        'lt': 'Lithuanian',
        'lb': 'Luxembourgish',
        'mk': 'Macedonian',
        'mg': 'Malagasy',
        'ms': 'Malay',
        'ml': 'Malayalam',
        'mt': 'Maltese',
        'mi': 'Maori',
        'mr': 'Marathi',
        'mn': 'Mongolian',
        'my': 'Myanmar (Burmese)',
        'ne': 'Nepali',
        'no': 'Norwegian',
        'ps': 'Pashto',
        'fa': 'Persian',
        'pl': 'Polish',
        'pt': 'Portuguese',
        'ma': 'Punjabi',
        'ro': 'Romanian',
        'ru': 'Russian',
        'sm': 'Samoan',
        'gd': 'Scots Gaelic',
        'sr': 'Serbian',
        'st': 'Sesotho',
        'sn': 'Shona',
        'sd': 'Sindhi',
        'si': 'Sinhala',
        'sk': 'Slovak',
        'sl': 'Slovenian',
        'so': 'Somali',
        'es': 'Spanish',
        'su': 'Sundanese',
        'sw': 'Swahili',
        'sv': 'Swedish',
        'tg': 'Tajik',
        'ta': 'Tamil',
        'te': 'Telugu',
        'th': 'Thai',
        'tr': 'Turkish',
        'uk': 'Ukrainian',
        'ur': 'Urdu',
        'uz': 'Uzbek',
        'vi': 'Vietnamese',
        'cy': 'Welsh',
        'xh': 'Xhosa',
        'yi': 'Yiddish',
        'yo': 'Yoruba',
        'zu': 'Zulu'
      },
      statusText: {
        0: ['waiting', '等待翻译'],
        1: ['padding', '正在翻译'],
        2: ['success', '翻译完成'],
        3: ['error', '翻译失败']
      },
      files: [],
      srcLang: 'auto',
      distLang: 'zh-cn'
    },
    computed: {
      hasFile() {
        return !!this.files.length
      }
    },
    methods: {
      process_file(e) {
        // console.log(e);
        const $input = this.$refs.input
        const files = [
          ...Array.from($input.files),
          ...Array.from(e.dataTransfer && e.dataTransfer.files || []),
        ]
        this.files = files.map(file => {
          const suffix = get_suffix(file.name)
          if (~['srt', 'ass'].indexOf(suffix)) {
            return {
              id: Math.random(),
              name: file.name,
              path:file.path,
              size: properFileSize(file.size),
              type: get_suffix(file.name),
              origin: file, // 原始 File 对象
              status: 0, // 0 未翻译, 1 正在翻译, 2 翻译完成, 3 翻译失败,
              parse: [], // 字幕文件解析后数据
              translateData: [], // parser 翻译后数据
            }
          }
        }).filter(i => i)
        $input.value = ''
      },
      // 取消文件选择
      removeFile(file) {
        this.files = this.files.filter(f => f.id != file.id)
      },
      // 点击区域选择文件
      toSelect() {
        this.$refs.input.click()
      },
      // 开始翻译
      startTranslate() {
        const translateProcess = []
        this.files.forEach(file => {
          file.status = 1
          try {
            translate(file.origin, this.distLang, this.srcLang).then(res => {
              file.parse = res.parse
              file.translateData = res.translate
              file.status = 2
            }).catch(err => {
              file.status = 3
            })
          } catch(e) {
            file.status = 3
          }
        })
      },
      downloadFile(file) {
        download(file, `[已翻译${this.srcLang} - ${this.distLang}]`).then(res => {
          console.log('下载完成')
        })
      }
    }
  })
</script>
<script src="./src/view.js"></script>

</html>